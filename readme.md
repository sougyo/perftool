# perftool

perftool provides tools which can convert sar-like file into csv format. Use it like as follows.
```
x2kv.py sar-output-file | kv2matrix.py
```

Input (sar.txt):
```
Linux 3.10.0-957.10.1.el7.x86_64 (cent76) 	05/02/19 	_x86_64_	(6 CPU)

21:04:36        CPU     %user     %nice   %system   %iowait    %steal     %idle
21:04:37        all      8.25      0.00      3.20      0.00      0.00     88.55
21:04:37          0      7.07      0.00      2.02      0.00      0.00     90.91
21:04:37          1      9.09      0.00      2.02      0.00      0.00     88.89
21:04:37          2      9.09      0.00      2.02      0.00      0.00     88.89
21:04:37          3      5.10      0.00      2.04      0.00      0.00     92.86
21:04:37          4      7.92      0.00      5.94      0.00      0.00     86.14
21:04:37          5      9.18      0.00      5.10      0.00      0.00     85.71
...
```

Output:
```
$ x2kv.py sar.txt | grep user | kv2matrix.py
time,%user.all,%user.0,%user.1,%user.2,%user.3,%user.4,%user.5
21:04:37,8.25,7.07,9.09,9.09,5.10,7.92,9.18
21:04:38,6.40,5.05,6.12,6.12,6.06,7.07,7.07
21:04:39,6.03,7.07,5.94,7.00,8.00,4.08,6.00
21:04:40,6.55,9.00,5.15,4.04,10.89,5.05,5.00
21:04:41,6.06,9.00,7.00,6.06,4.04,4.08,6.00
21:04:42,6.06,6.06,9.00,6.06,5.10,5.10,4.08
21:04:43,6.90,7.22,6.06,6.06,8.00,6.06,8.08
21:04:44,6.06,7.92,5.05,7.14,5.00,5.05,7.07
21:04:45,6.53,8.00,6.06,6.00,5.05,9.00,6.06
21:04:46,7.07,5.05,6.06,8.08,8.00,6.12,8.00
```

## x2kv.py

x2kv.py converts sar-like files into key-value pair format.

Usage:
```
x2kv.py [-t type] [file]
```

Example:
```
$ cat sar.txt
Linux 3.10.0-957.10.1.el7.x86_64 (cent76) 	05/02/19 	_x86_64_	(6 CPU)

21:04:36        CPU     %user     %nice   %system   %iowait    %steal     %idle
21:04:37        all      8.25      0.00      3.20      0.00      0.00     88.55
21:04:37          0      7.07      0.00      2.02      0.00      0.00     90.91
21:04:37          1      9.09      0.00      2.02      0.00      0.00     88.89
21:04:37          2      9.09      0.00      2.02      0.00      0.00     88.89
21:04:37          3      5.10      0.00      2.04      0.00      0.00     92.86
21:04:37          4      7.92      0.00      5.94      0.00      0.00     86.14
21:04:37          5      9.18      0.00      5.10      0.00      0.00     85.71
...
$ x2kv.py -t sar-u sar.txt
21:04:37,%user,all,8.25
21:04:37,%nice,all,0.00
21:04:37,%system,all,3.20
21:04:37,%iowait,all,0.00
21:04:37,%steal,all,0.00
21:04:37,%idle,all,88.55
21:04:37,%user,0,7.07
21:04:37,%nice,0,0.00
21:04:37,%system,0,2.02
21:04:37,%iowait,0,0.00
...
```

Output of x2kv.py consists of 4 columns: time, primary-key, secondary-key, and value. If `-t type` is omitted, x2kv.py guesses an appropriate type of input from its file name based on the rule written in `lib/hint.json`. If you could not obtain expected output, please try to use `-t` option to specify a type of input explicitly. You can get what types are available from `lib/spec.json`. sar-u is specified in the above example.

If `file` is omitted, x2kv.py will read input from stdin.


## kv2matrix.py

kv2matrix.py reads key-value pair format, which is generated by x2kv.py, from stdin and convert it into csv format file.


## kv2record.py / record2kv.py

kv2record.py can be used to assemble a record from key-value pairs, which were in the same line in the original data.

Let's say that we want to get value of %CPU of chrome process from the following output of top command.

```
$ head top.txt
top - 14:12:31 up  2:36,  3 users,  load average: 1.66, 1.73, 1.64
Tasks: 307 total,   1 running, 306 sleeping,   0 stopped,   0 zombie
%Cpu(s): 13.9 us,  7.0 sy,  0.0 ni, 74.8 id,  4.3 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem : 16113780 total, 10509764 free,  2958396 used,  2645620 buff/cache
KiB Swap:  8191996 total,  8191996 free,        0 used. 12156816 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND           P
11413 sougyo    20   0 1402096 317512 120212 S  38.9  2.0   8:31.89 chrome            2
24737 sougyo    20   0 1925308 621276  68684 S  22.2  3.9  21:35.38 atom              1
13906 sougyo    20   0  162164   2288   1564 R  11.1  0.0   0:00.04 top               4
...
```

x2kv.py can generate key-value pairs from the data, and enables us to obtain only %CPU value from the data by filtering with grep command, but it's still difficult to extract only chrome process data.

```
$ x2kv.py top.txt
14:12:31,USER,11413,sougyo
14:12:31,PR,11413,20
14:12:31,NI,11413,0
14:12:31,VIRT,11413,1402096
14:12:31,RES,11413,317512
14:12:31,SHR,11413,120212
14:12:31,S,11413,S
14:12:31,%CPU,11413,38.9
14:12:31,%MEM,11413,2.0
14:12:31,TIME+,11413,8:31.89
14:12:31,COMMAND,11413,chrome
14:12:31,P,11413,2
14:12:31,USER,24737,sougyo
14:12:31,PR,24737,20
14:12:31,NI,24737,0
14:12:31,VIRT,24737,1925308
14:12:31,RES,24737,621276
14:12:31,SHR,24737,68684
14:12:31,S,24737,S
14:12:31,%CPU,24737,22.2
14:12:31,%MEM,24737,3.9
14:12:31,TIME+,24737,21:35.38
14:12:31,COMMAND,24737,atom
14:12:31,P,24737,1
...
```

kv2record.py can assemble records from the above key-value pairs.

```
$ x2kv.py top.txt | kv2record.py
14:12:31,11413,USER,sougyo,PR,20,NI,0,VIRT,1402096,RES,317512,SHR,120212,S,S,%CPU,38.9,%MEM,2.0,TIME+,8:31.89,COMMAND,chrome,P,2
14:12:31,24737,USER,sougyo,PR,20,NI,0,VIRT,1925308,RES,621276,SHR,68684,S,S,%CPU,22.2,%MEM,3.9,TIME+,21:35.38,COMMAND,atom,P,1
...
```

From the above result, It's easy to extract only the information of chrome process. And after that we can restore it to key-value pair format with record2kv.py.

The following is an example how to obtain csv output which consists of %CPU of chrome process.

```
$ x2kv.py top.txt | kv2record.py | grep chrome | record2kv.py | grep %CPU | kv2matrix.py
time,%CPU.11413,%CPU.28837,%CPU.28790,%CPU.31400,%CPU.5510,%CPU.5539,%CPU.5554,%CPU.5570,%CPU.5584,%CPU.5605,%CPU.8250,%CPU.8280,%CPU.8307,%CPU.8327,%CPU.8341,%CPU.11192,%CPU.11260,%CPU.11428,%CPU.28800,%CPU.28801,%CPU.28806,%CPU.28811,%CPU.28879
14:12:31,38.9,11.1,5.6,5.6,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0
14:12:32,62.7,20.6,9.8,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0
14:12:33,82.5,17.5,2.9,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0
```

## filter.py

The main feature of filter.py are the followings:

- filter columns using regular expression (--regex)
- calculate statistics (--sum, --avg, --min, --max)
- sort columns (--sort_by_avg, --sort_by_max)

Input (matrix.csv):
```
time,%user.all,%user.0,%user.1,%user.2,%user.3,%user.4,%user.5
21:04:37,8.25,7.07,9.09,9.09,5.10,7.92,9.18
21:04:38,6.40,5.05,6.12,6.12,6.06,7.07,7.07
21:04:39,6.03,7.07,5.94,7.00,8.00,4.08,6.00
21:04:40,6.55,9.00,5.15,4.04,10.89,5.05,5.00
21:04:41,6.06,9.00,7.00,6.06,4.04,4.08,6.00
21:04:42,6.06,6.06,9.00,6.06,5.10,5.10,4.08
21:04:43,6.90,7.22,6.06,6.06,8.00,6.06,8.08
21:04:44,6.06,7.92,5.05,7.14,5.00,5.05,7.07
21:04:45,6.53,8.00,6.06,6.00,5.05,9.00,6.06
21:04:46,7.07,5.05,6.06,8.08,8.00,6.12,8.00
```

Output:
```
$ filter.py --regex "\.(2|3|4)$" matrix.csv
time,%user.2,%user.3,%user.4
21:04:37,9.1,5.1,7.9
21:04:38,6.1,6.1,7.1
21:04:39,7.0,8.0,4.1
21:04:40,4.0,10.9,5.0
21:04:41,6.1,4.0,4.1
21:04:42,6.1,5.1,5.1
21:04:43,6.1,8.0,6.1
21:04:44,7.1,5.0,5.0
21:04:45,6.0,5.0,9.0
21:04:46,8.1,8.0,6.1
```


## plot.py

plot.py makes a chart from csv file. Use it like as follows.

```
plot.py -w out.png
```
